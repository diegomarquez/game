<!DOCTYPE html><html lang="en"><head><title>loose_state_machine/main</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="loose_state_machine/main"><meta name="groc-project-path" content="work/examples/loose_state_machine/main.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">work/examples/loose_state_machine/main.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h3 id="bydiegoenriquemarquezhttpwwwtreintipollocom">By <a href="http://www.treintipollo.com">Diego Enrique Marquez</a></h3>

<h3 id="findmeongithubhttpsgithubcomdiegomarquez"><a href="https://github.com/diegomarquez">Find me on Github</a></h3>

<p>Depends of:
<a href="@@gb@@">gb</a>,
<a href="@@game@@">game</a>,
<a href="@@state-machine@@">state-machine</a>,
<a href="@@keyboard@@">keyboard</a></p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper"><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">gb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gb&#39;</span><span class="p">);</span>
  
  <span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">gb</span><span class="p">.</span><span class="nx">game</span><span class="p">;</span>

  <span class="nx">game</span><span class="p">.</span><span class="nx">add_extension</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;activity-display&quot;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The first thing to do is get a hold to a reference to the state-machine_factory.
This thing will let you instantiate different kinds of state machines and their states.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">stateMachineFactory</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;state-machine&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">keyboard</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">state_1_label</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;label_1&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">state_2_label</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;label_2&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">state_3_label</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;label_3&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">currentState</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;label_4&#39;</span><span class="p">);</span>

  <span class="nx">state_1_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">;</span>
  <span class="nx">state_2_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
  <span class="nx">state_3_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the main initialization function</p></div></div><div class="code"><div class="wrapper">  <span class="nx">game</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">CREATE</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Welcome to Game-Builder!&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This will create a loose state machine.
By loose I mean that every state in the state machine can stop execution and pass
control to any other state at any given point. Concerns are separated, but it's pretty
flexible. The down side is that each state needs to know the IDs of the other states.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">looseStateMachine</span> <span class="o">=</span> <span class="nx">stateMachineFactory</span><span class="p">.</span><span class="nx">createLooseStateMachine</span><span class="p">();</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The main purpose of this state machine is to provide a simple way to define
sets of code with three actions, start, update and complete.
start gets called when entering the state and complete when exiting.
The update action has to be called manually when you think it is best.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create some states</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">state_1</span> <span class="o">=</span> <span class="nx">stateMachineFactory</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;state_1_name&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">state_2</span> <span class="o">=</span> <span class="nx">stateMachineFactory</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;state_2_name&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">state_3</span> <span class="o">=</span> <span class="nx">stateMachineFactory</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;state_3_name&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add some actions to each phase of a state</p></div></div><div class="code"><div class="wrapper">    <span class="nx">state_1</span><span class="p">.</span><span class="nx">addStartAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 1 just started&#39;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>

      <span class="nx">currentState</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s1">&#39;CURRENT STATE: STATE 1&#39;</span><span class="p">;</span>

      <span class="nx">state_1_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">;</span>
      <span class="nx">state_2_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
      <span class="nx">state_3_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">state_1</span><span class="p">.</span><span class="nx">addCompleteAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 1 just completed&#39;</span><span class="p">);</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">state_2</span><span class="p">.</span><span class="nx">addStartAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 2 just started&#39;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> 

      <span class="nx">currentState</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s1">&#39;CURRENT STATE: STATE 2&#39;</span><span class="p">;</span>

      <span class="nx">state_2_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">;</span>
      <span class="nx">state_1_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
      <span class="nx">state_3_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">state_2</span><span class="p">.</span><span class="nx">addCompleteAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 2 just completed&#39;</span><span class="p">);</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">state_3</span><span class="p">.</span><span class="nx">addStartAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 3 just started&#39;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> 

      <span class="nx">currentState</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s1">&#39;CURRENT STATE: STATE 3&#39;</span><span class="p">;</span>

      <span class="nx">state_3_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">;</span>
      <span class="nx">state_2_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
      <span class="nx">state_1_label</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nx">state_3</span><span class="p">.</span><span class="nx">addCompleteAction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;State 3 just completed&#39;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> 
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wiring up some really crud state change logic
Note that only the currently executing state can signal the state machine to change state.
If some other state does so, because of nefarious code, such as this example, nothing will happen.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">keyboard</span><span class="p">.</span><span class="nx">onKeyUp</span><span class="p">(</span><span class="nx">keyboard</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">state_1</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">next</span><span class="o">:</span><span class="s1">&#39;state_2_name&#39;</span><span class="p">,</span> <span class="nx">nextInitArgs</span><span class="o">:</span><span class="s1">&#39;Hello from state 1&#39;</span><span class="p">,</span> <span class="nx">lastCompleteArgs</span><span class="o">:</span><span class="s1">&#39;Good bye state 1&#39;</span><span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">keyboard</span><span class="p">.</span><span class="nx">onKeyUp</span><span class="p">(</span><span class="nx">keyboard</span><span class="p">.</span><span class="nx">S</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">state_2</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">next</span><span class="o">:</span><span class="s1">&#39;state_3_name&#39;</span><span class="p">,</span> <span class="nx">nextInitArgs</span><span class="o">:</span><span class="s1">&#39;Hello from state 2&#39;</span><span class="p">,</span> <span class="nx">lastCompleteArgs</span><span class="o">:</span><span class="s1">&#39;Good bye state 2&#39;</span><span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">keyboard</span><span class="p">.</span><span class="nx">onKeyUp</span><span class="p">(</span><span class="nx">keyboard</span><span class="p">.</span><span class="nx">D</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">state_3</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">next</span><span class="o">:</span><span class="s1">&#39;state_1_name&#39;</span><span class="p">,</span> <span class="nx">nextInitArgs</span><span class="o">:</span><span class="s1">&#39;Hello from state 3&#39;</span><span class="p">,</span> <span class="nx">lastCompleteArgs</span><span class="o">:</span><span class="s1">&#39;Good bye state 3&#39;</span><span class="p">});</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally this will add the states into the state machine.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">looseStateMachine</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">state_1</span><span class="p">);</span>
    <span class="nx">looseStateMachine</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">state_2</span><span class="p">);</span>
    <span class="nx">looseStateMachine</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">state_3</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don't forget to start the state machine if you don't none of this nonesense will work.
You can send in what ever you want as arguments, they will be passed to the initial state.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">looseStateMachine</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;State machine was started!&#39;</span><span class="p">);</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is called when the canvas looses focus</p></div></div><div class="code"><div class="wrapper">  <span class="nx">game</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">BLUR</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;loose-state-machine has lost focus&quot;</span><span class="p">);</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is called when the canvas regains focus</p></div></div><div class="code"><div class="wrapper">  <span class="nx">game</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">FOCUS</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;loose-state-machine has regained focus&quot;</span><span class="p">);</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the main update loop</p></div></div><div class="code"><div class="wrapper">  <span class="nx">game</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">UPDATE</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do stuff here that needs constant updating</p></div></div><div class="code"><div class="wrapper">    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this.delta => Time delta between updates
this.context => 2D Context where stuff is drawn</p></div></div><div class="code"><div class="wrapper">  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the main setup that kicks off the whole thing
Notice how it needs to find a '#main' and '#game' in the document</p></div></div><div class="code"><div class="wrapper">  <span class="nx">game</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;game&#39;</span><span class="p">));</span>
<span class="p">});</span></div></div></div></div></body></html>