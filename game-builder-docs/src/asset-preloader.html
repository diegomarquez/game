<!DOCTYPE html><html lang="en"><head><title>src/asset-preloader</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/asset-preloader"><meta name="groc-project-path" content="work/game-builder/src/asset-preloader.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">work/game-builder/src/asset-preloader.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="asset-preloaderjs">asset-preloader.js</h1>

<h3 id="bydiegoenriquemarquezhttpwwwtreintipollocom">By <a href="http://www.treintipollo.com">Diego Enrique Marquez</a></h3>

<h3 id="findmeongithubhttpsgithubcomdiegomarquez"><a href="https://github.com/diegomarquez">Find me on Github</a></h3>

<p>Inherits from:</p>

<p>Depends of:
<a href="@@asset-map@@">asset-map</a>
<a href="http://diegomarquez.github.io/game-builder/game-builder-docs/src/debug/error-printer.html">error-printer</a></p>

<p>A <a href="http://requirejs.org/">requireJS</a> module. For use with <a href="http://diegomarquez.github.io/game-builder">Game-Builder</a></p>

<p>This module is used to preload any type of asset that is required to already be cached by the browser before
the application starts. This is mostly used to avoid graphics taking a split second to appear the first time they
are requested.</p>

<p>This should only be used to avoid graphical or audio glitches. Lazy loading should always be favored.</p>

<p>The Asset Preloader object extends <a href="http://diegomarquez.github.io/game-builder/game-builder-docs/src/delegate.html">delegate</a> so it provides a few events to hook into:</p>

<h3 id="on_load_all_complete"><strong>ON<em>LOAD</em>ALL_COMPLETE</strong></h3>

<p>When loading of resources through the <strong>loadAll</strong> method is complete.</p>

<pre><code class=" javascript">assetPreloader.on(assetPreloader.ON_LOAD_ALL_COMPLETE, function() {});
</code></pre>

<p></br></p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="preload">Preload!</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;delegate&#39;</span><span class="p">,</span> <span class="s1">&#39;asset-map&#39;</span><span class="p">,</span> <span class="s1">&#39;error-printer&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Delegate</span><span class="p">,</span> <span class="nx">AssetMap</span><span class="p">,</span> <span class="nx">ErrorPrinter</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">AssetPreloader</span> <span class="o">=</span> <span class="nx">Delegate</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p style='color:#AD071D'><strong>init</strong></p>

<p>Constructor</p></div></div><div class="code"><div class="wrapper">    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">cachedImages</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cachedAudio</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">supportedAudioFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>getCachedImage</strong></p>

<p>Get an image that has been previously cached</p>

<p>Parameters:</p>

<ul>
<li><strong>id must be a Strin.</strong><br/>(The path to the resource)</li>
</ul>

<p><strong>Returns an Image</strong></p></div></div><div class="code"><div class="wrapper">    <span class="nx">getCachedImage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cachedImages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>getCachedAudio</strong></p>

<p>Get an audio element or an ArrayBuffer that has been previously cached</p>

<p>Parameters:</p>

<ul>
<li><strong>id must be a String.</strong><br/>(The path to the resource)</li>
</ul>

<p><strong>Returns an Audio  or a  ArrayBuffer</strong></p></div></div><div class="code"><div class="wrapper">    <span class="nx">getCachedAudio</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cachedAudio</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>addAsset</strong></p>

<p>Add an asset to be loaded.</p>

<p>Parameters:</p>

<ul>
<li><strong>path must be a String.</strong><br/>(A path to an asset)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">addAsset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^.+\.(.+?)(?=\?|$)/</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ErrorPrinter</span><span class="p">.</span><span class="nx">printError</span><span class="p">(</span><span class="s1">&#39;Asset Preloader: path is not a url&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;png&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;gif&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cachedImages</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span>
          <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;opus&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;weba&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;ogg&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s2">&quot;mp3&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cachedAudio</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span>
          <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">ErrorPrinter</span><span class="p">.</span><span class="nx">printError</span><span class="p">(</span><span class="s1">&#39;Asset Preloader: file type is not supported&#39;</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>canPreload</strong></p>

<p>Check if the asset can be prealoded</p>

<p>Parameters:</p>

<ul>
<li><strong>path must be a String.</strong><br/>(A path to an asset)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">canPreload</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^.+\.(.+?)(?=\?|$)/</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ErrorPrinter</span><span class="p">.</span><span class="nx">printError</span><span class="p">(</span><span class="s1">&#39;Asset Preloader: path is not a url&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;png&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;gif&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;opus&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;weba&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;ogg&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s2">&quot;mp3&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>loadAll</strong></p>

<p>Start loading all the provided assets and fire the ON<em>LOAD</em>ALL_COMPLETE when
eerything is done loading</p>

<p>Parameters:</p>

<ul>
<li><strong>id must be a String.</strong><br/>(Id of the sound that has channels assigned)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">loadAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">imagesToLoad</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">audioToLoad</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">((</span><span class="nx">imagesToLoad</span> <span class="o">+</span> <span class="nx">audioToLoad</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_LOAD_ALL_COMPLETE</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">);</span>

        <span class="nx">image</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">cachedImages</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">gru</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

          <span class="nx">imagesToLoad</span><span class="o">--</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">imagesToLoad</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">audioToLoad</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_LOAD_ALL_COMPLETE</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

        <span class="nx">image</span><span class="p">.</span><span class="nx">gru</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}(</span><span class="nx">path</span><span class="p">);</span>

        <span class="nx">image</span><span class="p">.</span><span class="nx">crossOrigin</span> <span class="o">=</span> <span class="s1">&#39;Anonymous&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;file:&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:5000/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">audioContext</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitAudioContext</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">convertPathToSupportedAudioFormat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">audioContext</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

          <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;file:&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://localhost:5000/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="nx">request</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="s1">&#39;arraybuffer&#39;</span><span class="p">;</span>

          <span class="nx">request</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">cachedAudio</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">gru</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>

            <span class="nx">audioToLoad</span><span class="o">--</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">imagesToLoad</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">audioToLoad</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_LOAD_ALL_COMPLETE</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

          <span class="nx">request</span><span class="p">.</span><span class="nx">gru</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}(</span><span class="nx">path</span><span class="p">);</span>

          <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">audio</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;audio&#39;</span><span class="p">);</span>

          <span class="nx">audio</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;canplaythrough&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">cachedAudio</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">gru</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

            <span class="nx">audioToLoad</span><span class="o">--</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">imagesToLoad</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">audioToLoad</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">imagesToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">audioToLoad</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_LOAD_ALL_COMPLETE</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

          <span class="nx">audio</span><span class="p">.</span><span class="nx">gru</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}(</span><span class="nx">path</span><span class="p">);</span>

          <span class="nx">audio</span><span class="p">.</span><span class="nx">preload</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;file:&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:5000/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">    <span class="nx">convertPathToSupportedAudioFormat</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^.+\.)(.+?)(?=(\?.+))/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportedAudioFormat</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">    <span class="nx">findSupportedAudioFormat</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onComplete</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">loadAudioFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">supportedFormat</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">audio</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;audio&#39;</span><span class="p">);</span>

        <span class="nx">audio</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;canplaythrough&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportedAudioFormat</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">supportedAudioFormat</span> <span class="o">=</span> <span class="nx">supportedFormat</span><span class="p">;</span>

            <span class="nx">onComplete</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

        <span class="nx">audio</span><span class="p">.</span><span class="nx">preload</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;file:&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:5000/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

      <span class="nx">loadAudioFile</span><span class="p">(</span><span class="nx">AssetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">()[</span><span class="s1">&#39;AUDIO-SAMPLE.OGG&#39;</span><span class="p">],</span> <span class="s2">&quot;ogg&quot;</span><span class="p">);</span>
      <span class="nx">loadAudioFile</span><span class="p">(</span><span class="nx">AssetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">()[</span><span class="s1">&#39;AUDIO-SAMPLE.MP3&#39;</span><span class="p">],</span> <span class="s2">&quot;mp3&quot;</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  <span class="p">});</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">AssetPreloader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;ON_LOAD_ALL_COMPLETE&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;load_all_complete&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">AssetPreloader</span><span class="p">();</span>
<span class="p">});</span></div></div></div></div></body></html>