<!DOCTYPE html><html lang="en"><head><title>src/states/state-machine</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/states/state-machine"><meta name="groc-project-path" content="work/game-builder/src/states/state-machine.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">work/game-builder/src/states/state-machine.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="state-machinejs">state-machine.js</h1>

<h3 id="bydiegoenriquemarquezhttpwwwtreintipollocom">By <a href="http://www.treintipollo.com">Diego Enrique Marquez</a></h3>

<h3 id="findmeongithubhttpsgithubcomdiegomarquez"><a href="https://github.com/diegomarquez">Find me on Github</a></h3>

<p>Inherits from: 
<a href="http://localhost:5000/game-builder-docs/src/class.html">class</a></p>

<p>Depends of: 
<a href="http://localhost:5000/game-builder-docs/src/states/state.html">state</a>
<a href="http://localhost:5000/game-builder-docs/src/debug/error-printer.html">error-printer</a></p>

<p>A <a href="http://requirejs.org/">requireJS</a> module. For use with <a href="http://diegomarquez.github.io/game-builder">Game-Builder</a></p>

<p>This module allows you to setup <a href="http://en.wikipedia.org/wiki/Finite-state_machine">finite state machines</a>.
It's a pretty useful pattern in game development, as it's a rather easy way to organize and coordinate different
pieces of code without abusing <em>'if'</em> statements.</p>

<p>The module provides 2 types of <strong>state machines</strong></p>

<p>The first <strong>"loose"</strong> type, allows you to just go from state to state, with no restriction. 
It's pretty usefull, but states need to know about the other states in order to change control flow to them. 
That isn't so good, but it works for small bits of code.</p>

<p>The second <strong>"fixed"</strong> type, lets you configure the order of execution of states. In these state machines, a state needs know
nothing about other states, which is a good thing. On it's insides, it just says it wants to go to the next state,
and stuff happens. No need to know identifiers of any sort. It's a bit more rigid, but could save some headaches if used in the proper
situation.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="encapsulation-is-good">Encapsulation is good</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper"><span class="nx">define</span><span class="p">([</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;error-printer&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Class</span><span class="p">,</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">ErrorPrinter</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">StateMachine</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stateIds</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">states</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>start</strong></p>

<p>Start the state machine.</p>

<p>Once the states have been added, call this method to go into
the first state, optionally sending some arguments.</p>

<p>Parameters:</p>

<ul>
<li><strong>args is optional, must be an Object, and has a default value of null.</strong><br/>(Arguments to be sent to the initial state. )</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>add</strong></p>

<p>Add a state object to the state machine.</p>

<p>This method is redifined by the concrete implementations.</p>

<p>Parameters:</p>

<ul>
<li><strong>state must be a State.</strong><br/>(State object to add)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stateIndex</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">stateIds</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stateIndex</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stateIds</span><span class="p">[</span><span class="nx">stateIndex</span><span class="p">.</span><span class="nx">toString</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">stateIndex</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>get</strong></p>

<p>Get a reference to a state.</p>

<p>Parameters:</p>

<ul>
<li><strong>stateIdOrName can be a String or a Number.</strong><br/>(State id or name)</li>
</ul>

<p><strong>Returns a State</strong><br/>(The requested state)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stateIdOrName</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">[</span><span class="nx">getStateId</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">stateIdOrName</span><span class="p">)];</span> 
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p style='color:#AD071D'><strong>block</strong></p>

<p>Blocks the state machine.</p>

<p>While blocked no actions will be executed, 
and state changes can not occur.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">block</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p style='color:#AD071D'><strong>unblock</strong></p>

<p>Unblock the state machine.</p>

<p>All behaviour returns to normal after executing this method.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">unblock</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p style='color:#AD071D'><strong>update</strong></p>

<p>Execute the update actions of the state machine. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">].</span><span class="nx">update</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p style='color:#AD071D'><strong>destroy</strong></p>

<p>Calls the destroy method of all the states registered.</p>

<p>Nulls the main references. Sets the object up for garbage collection.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">states</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="loosestatemachineextendsstatemachine"><strong>LooseStateMachine</strong> extends <strong>StateMachine</strong></h2></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">LooseStateMachine</span> <span class="o">=</span> <span class="nx">StateMachine</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>add</strong></p>

<p>Add a state object to the state machine.</p>

<p>Setup the <strong>change</strong> event of the state, so it is able to pass control flow
to another state.</p>

<p>When executing the <strong>change</strong> event an argument is required to be passed. ej.</p>

<pre><code class=" javascript">state.execute('change', {
    // Name of the state to pass control to
    // This is required
    next: 'StateName'
    // This will be passed as arguments to the complete actions of the current state
    // This is optional
    lastCompleteArgs: {},
    // This will be passed as arguments to the start actions of the next state
    // This is optional 
    nextInitArgs: {}
});
</code></pre>

<p>Parameters:</p>

<ul>
<li><strong>state must be a State.</strong><br/>(State object to add)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">CHANGE</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">canNotMoveToNewState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">state</span><span class="p">))</span> <span class="p">{</span> 
          <span class="k">return</span><span class="p">;</span> 
        <span class="p">}</span> 

        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">lastCompleteArgs</span><span class="p">);</span>
        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">getStateId</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">next</span><span class="p">),</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">nextInitArgs</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="fixedstatemachineextendsstatemachine"><strong>FixedStateMachine</strong> extends <strong>StateMachine</strong></h2></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">FixedStateMachine</span> <span class="o">=</span> <span class="nx">StateMachine</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p style='color:#AD071D'><strong>add</strong></p>

<p>Add state object to the state machine.</p>

<p>Setup the <strong>next</strong> and <strong>previous</strong> events of the state, 
so it is able to pass control flow to the corresponding states.</p>

<p>When executing the <strong>next</strong> and <strong>previous</strong> events an argument is optional. ej.</p>

<pre><code class=" javascript  ">state.execute('next', {
    // This will be passed as arguments to the complete actions of the current state
    // This is optional
    lastCompleteArgs: {},
    // This will be passed as arguments to the start actions of the next state
    // This is optional 
    nextInitArgs: {}
});
</code></pre>

<p>Parameters:</p>

<ul>
<li><strong>state must be a State.</strong><br/>(State object to add)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">NEXT</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">canNotMoveToNewState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">state</span><span class="p">))</span> <span class="p">{</span> 
          <span class="k">return</span><span class="p">;</span> 
        <span class="p">}</span>

        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">lastCompleteArgs</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>      
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">nextInitArgs</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">state</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">PREVIOUS</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">canNotMoveToNewState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">state</span><span class="p">))</span> <span class="p">{</span> 
          <span class="k">return</span><span class="p">;</span> 
        <span class="p">}</span>

        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">lastCompleteArgs</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="o">--</span><span class="p">;</span> <span class="p">}</span>      
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

        <span class="nx">executeStateAction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">nextInitArgs</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">    
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="statemachinefactory"><strong>State Machine Factory</strong></h2></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">StateMachineFactory</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a "loose" state machine</p></div></div><div class="code"><div class="wrapper">    <span class="nx">createLooseStateMachine</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">LooseStateMachine</span><span class="p">();</span> <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a "fixed" state machine</p></div></div><div class="code"><div class="wrapper">    <span class="nx">createFixedStateMachine</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">FixedStateMachine</span><span class="p">();</span> <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a state, send in the scope for the state and a name</p></div></div><div class="code"><div class="wrapper">    <span class="nx">createState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  
  <span class="kd">var</span> <span class="nx">executeStateAction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stateId</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">states</span><span class="p">[</span><span class="nx">stateId</span><span class="p">][</span><span class="nx">action</span><span class="p">](</span><span class="nx">args</span><span class="p">);</span> 
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ErrorPrinter</span><span class="p">.</span><span class="nx">printError</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;State with id: &#39;</span> <span class="o">+</span> <span class="nx">stateId</span> <span class="o">+</span> <span class="s1">&#39; caused an un expected error.&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">=</span> <span class="nx">stateId</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">getStateId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stateIdOrName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIds</span><span class="p">[</span><span class="nx">stateIdOrName</span><span class="p">.</span><span class="nx">toString</span><span class="p">()]</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">canNotMoveToNewState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">changingStateId</span> <span class="o">=</span> <span class="nx">getStateId</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentStateId</span> <span class="o">!=</span> <span class="nx">changingStateId</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">states</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">StateMachineFactory</span><span class="p">;</span>
<span class="p">});</span></div></div></div></div></body></html>